+++
title = "Using Power Automate to collect Powershell script results"
date = "2023-09-28T10:11:07+02:00"
author = ""
authorTwitter = "" #do not include @
cover = ""
description = "Quick explanation and example on how to use Power Automate to collect PowerShell script output/logs."
showFullContent = false
readingTime = false
hideComments = false
color = "" #color from the theme settings
+++

## Intro

When using PowerShell script deployed via GPO or Intune it can be a bit annoying to gather the exact results or script output.
This is where you can use Power Automate, with Power Automate you can do a lot of things with your script output but in this example we will save the result in a Sharepoint List which gives us a clear view of all the executions of our script.

## Requirements

- A Power Automate Premium license (90 day trial is available)

> *NOTE: My flow kept working after my 90 day trial expired but you are not able to create new flows with this trigger*

## Creating the Flow

[Create a new Flow](https://make.powerautomate.com) as the trigger use **When a HTTP request is received**, under the **advanced options** set the method to **POST** as we are posting data to the Flow.

{{< image src="/power-automate-powershell/img/flow-trigger.png" alt="Flow Trigger" position="left" style="border-radius: 8px;" >}}

We will set the **Request Body JSON Schema** to:

{{< code language="json" title="Request Body JSON Schema" id="1" expand="Show" collapse="Hide" isCollapsed="false" >}}
{
    "type": "object",
    "properties": {
        "Customer": {
            "type": "string"
        },
        "Device": {
            "type": "string"
        },
        "Result": {
            "type": "string"
        },
        "LogFile": {
            "type": "string"
        }
    }
}
{{< /code >}}

In this example we will collect the following properties from our Powershell script:

- Customer
- Device
- Result
- LogFile

> We send the **LogFile** in *String* format because we will base64 encode the logfile with Powershell and decode it again in our Flow, this is because the Flow trigger does not support receiving files.

We will also initialize a variable with the value of the current date and time:
{{< image src="/power-automate-powershell/img/flow-init-date.png" alt="Initialize Date variable" position="left" style="border-radius: 8px;" >}}

The next step in our Flow will be to save the data to a SharePoint List, but before we can do that we need to [create](https://support.microsoft.com/en-au/office/create-a-list-0d397414-d95f-41eb-addd-5e6eff41b083 "How to create a Sharepoint List") the list. In our list we will add the following columns:

| Column Name  | Column Type |
|---|---|
| Customer  | Text |
| Device | Text |
| Result | Text |
| LogFile | HyperLink |
| Date | Date (including Time) |

You should also [create a Document Library](https://support.microsoft.com/en-au/office/create-a-document-library-in-sharepoint-306728fe-0325-4b28-b60d-f902e1d75939 "How to create a Document Library") where the logfiles will be saved.

Back to our Flow we will add a new **Compose** action:

{{< image src="/power-automate-powershell/img/flow-compose-file.png" alt="Add Compose Action" position="left" style="border-radius: 8px;" >}}

> *NOTE: In this example we use a .txt file, if you want to use other file types replace the content-type to the one corresponding with the file extension. See [link](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types "Common MIME types")*

Next we will save the file to the Document Library we created earlier:

{{< image src="/power-automate-powershell/img/flow-create-file.png" alt="Create and save file to Sharepoint Document Library" position="left" style="border-radius: 8px;" >}}

In our Sharepoint List we want to link to the LogFile we uploaded. To get the URL we will need to get the file properties via:

{{< image src="/power-automate-powershell/img/flow-get-file-url.png" alt="Get LogFile URL" position="left" style="border-radius: 8px;" >}}

And the last step in our Flow is to create a list item:

{{< image src="/power-automate-powershell/img/flow-create-list-item.png" alt="Create list item" position="left" style="border-radius: 8px;" >}}

## Creating our PowerShell script

Here is an really basic example script:

{{< code language="powershell" title="Example script" id="1" expand="Show" collapse="Hide" isCollapsed="false" >}}
Start-Transcript -Path ".\LogFile.txt" -NoClobber

# YOUR
# SCRIPT
# HERE
# $result should be defined in here!!

Stop-Transcript

# The URI generated by the Power Automate Flow
$URI = "https://prod-230.westeurope.logic.azure.com:443/workflows/xxxxxxxxxxx"
# Setting our customer name
$customer = "customer name"
# Setting the $device variable equal to the current device name
$device = $env:computername
# Converting our LogFile to a base64 string
$logfile = [convert]::ToBase64String((Get-Content -path ".\LogFile.txt" -Encoding byte))
# Remove LogFile as we won't need it on the system any longer.
Remove-Item -Path ".\LogFile.txt"

# Composing the request body
$body = ConvertTo-JSON @{
    Customer = $customer 
    Device = $device;
    Result = $result;
    LogFile = $logfile
}
# Triggering Flow to register results to 
Invoke-RestMethod -uri $URI -Method Post -body $body -ContentType 'application/json'
{{< /code >}}

You can get the URL from your Flow after saving it:

{{< image src="/power-automate-powershell/img/flow-request-uri.png" alt="Trigger URL" position="left" style="border-radius: 8px;" >}}

After we execute the script you will see a new item added to our list:

{{< image src="/power-automate-powershell/img/sharepoint-list-item.png" alt="Sharepoint List Ite" position="left" style="border-radius: 8px;" >}}

You will also see the logfile is uploaded to the folder:

{{< image src="/power-automate-powershell/img/sharepoint-logfile.png" alt="LogFile created in Sharepoint" position="left" style="border-radius: 8px;" >}}

The script used is very simple but you can use this in a lot of different ways. The Sharepoint list will also allow you to easily sort by customer/device/result.

The LogFile gives you insight on what errors occured within the script output.
